#!/bin/bash

# Path:        ~/biurko/bash/queuempv.sh
# Created:     11.07.18, 01:26    @x200
# Last update: 18.07.18, 13:48:37 @x200

# Doc:

TARGET="$1"
SOC=/tmp/mpv
MOC_STATUS=$(mocp -i | grep "State:" | sed -e "s/^.*: //")

if [ "$MOC_STATUS" = "PLAY" ]; then
    mocp -P
fi

if [[ $(xdotool search --class mpv) ]]; then
    echo "{ \"command\": [ \"loadfile\", \"$TARGET\", \"append-play\" ] }" | socat - $SOC &
    notify-send -u low "Queuempv:
---------" "Video\n\n`curl $1 -so - | grep -iPo '(?<=<title>)(.*)(?=</title>)'`\n\nappended to playlist"
        # echo "loadfile \"$TARGET\" append-play" > /tmp/mp_pipe
        # notify-send -u low "Urlview" "Video:\n\n<i>`curl -s $TARGET | grep -o \"<title>[^<]*\" | tail -c+8`</i>\n\nis loading."
else
    mpv --save-position-on-quit --input-ipc-server=$SOC "$TARGET" &
    notify-send -u low "Queuempv:
---------" "Video\n\n`curl $1 -so - | grep -iPo '(?<=<title>)(.*)(?=</title>)'`\n\nloading"
    # [[ -e /tmp/mp_pipe ]] || mkfifo /tmp/mp_pipe
    # --input-file=/tmp/mp_pipe "$TARGET" &
    # notify-send -u low "Urlview" "Video:\n\n<i>`curl -s $TARGET | grep -o \"<title>[^<]*\" | tail -c+8`</i>\n\nis loading."
fi

    
