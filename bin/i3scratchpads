#!/bin/bash

# Path:        ~/.dotfiles/bin/scratchpad.sh
# Created:     2018-10-13, 01:19    @lenovo
# Last update: 2019-04-05, 21:29:46 @x200
# Doc:         start tmux scratchpad if doesn't exist or show it
# Requires:    i3move; i3get

I3MOVE=$HOME/bin/i3move
I3GET=$HOME/git/lab/py-exercises/i3get.py
I3EXEC="exec --no-startup-id"
TRM=st

i3msg() {
    i3-msg -q "$@" && sleep 0.1
}

is_running() {
    ps aux | grep $1 | grep -v grep
}

usage() {
    cat <<EOF
usage:   $0 [-u][-f][-c][-o][-t][-h]

 options:
  -u     run tmux 
  -f     run quickterm (bottom of screen) 
  -c     run calculator
  -o     run whitaker words 
  -t     run clock

EOF
}

main() {
    if [[ -n $1 ]]; then
        while getopts "ufcot:" flag; do
            case "${flag}" in
                # tmux
                u) if [[ ! $(is_running dropdown) ]]; then 
                       ARGS="-c scratch -t dropdown"
                       COMMAND="-e ~/.dotfiles/bin/tmux-starter.sh"
                       i3msg "$I3EXEC $TRM $ARGS $COMMAND"
                       i3msg "[title=\"dropdown\"] scratchpad show" \
                             && $I3MOVE -p 70 -m c
                       pkill -RTMIN+10 i3blocks  # refresh mail count
                   else
                       i3msg "[title=\"dropdown\"] scratchpad show"
                       [[ $($I3GET -n) =~ "dropdown" ]] \
                           && $i3MOVE -p 70 -m c
                   fi
                   ;;
                # quick scratch
                f) if [[ ! $(is_running myquickterm) ]]; then
                       ARGS="-c myquickterm"
                       i3msg "$I3EXEC $TRM $ARGS"
                   fi
                   i3msg "[class=\"myquickterm\"] scratchpad show" \
                       && [[ $($I3GET -c) =~ myquickterm ]] \
                       && $I3MOVE -s -m 3
                   ;;
                # calc
                c) if [[ ! $(is_running m4ath) ]]; then
                       ARGS="-c calculator -t m4ath -e R -q"
                       i3msg "$I3EXEC $TRM $ARGS"
                   fi
                   i3msg "[class=\"calculator\"] scratchpad show" \
                       && [[ $($I3GET -c) =~ calculator ]] \
                       && $I3MOVE -m c
                   ;;
                # whitaker words
                o) if [[ ! $(is_running w0rds) ]]; then
                       ARGS="-c whit4ker -t w0rds -e words"
                       i3msg "$I3EXEC $TRM $ARGS"
                   fi
                   i3msg "[title=\"w0rds\"] scratchpad show" \
                         && $I3MOVE -p 40 -m sw -g 15
                   ;;
                # clock
                t) if [[ ! $(is_running tty-clock) ]]; then
                       ARGS="-c cl0ck -t tty-clock -f 'monospace:size=10' -e tty-clock -C $OPTARG -c -b "
                       i3msg "$I3EXEC $TRM $ARGS"
                   fi
                   if [[ $($I3GET -c) == cl0ck ]]; then
                       $I3MOVE -p 22 -g 15 -m se
                       i3msg "sticky enable"
                   fi
                   ;;
            esac
        done
    else
        usage
    fi
}

main "$@"
